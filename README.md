<p align="center">
  <img src="./assets/icons/tiny-drive_logo.svg" />
</p>

# **TinyDrive (Server)**

TinyDrive is a personal project, that is inspired by the Google's Drive interface and cloud storage. This project was developt to explore concepts and apply them is a somewhat real project.

TinyDrive was created for you store files on the cloud in a easy way and download or preview its content.

You can access the project and test it using this link: [Tiny Drive](https://tiny-drive.vercel.app/login)

if you don't want to login with your own email, you can use this login I've created for tests:

```
Email: tiny.test.drive@gmail.com
Senha: 12345678
```

# Main Features

-   **Standarized API Responses:** All the API endpoints will return an standarized response, making the API predictable. The models for the responses are created with pydantic models.
-   **File Optimization:** The files are compressed before being stored in the storage service.
-   **File Contents Preview:**
    -   The previews are generated in background, without blocking or slowing down the file upload and response
    -   All previews are resized to fit in 1920x1080px, and converted into "JPEG" for opmization and to reduce the preview size even more.
    -   Previews are delivered by a signed-url generated by the storage provider (Supabase), which are cached in the browser using the HTTP `Cache-Control` header.
-   **Scheduled Item Deletetion:** For better user experience the items are only marked to be deleted when request to delete an item, creating faster responses.
-   **Authentication:** User authentication using the supabase authentication service. Authentication middleware validating the JWT token and the account mismatch between the token and the requested userid.
-   **BLOB Storage**: The files data are stored in the supabase storage service.
-   **Custom Exceptions Handling**: Use of custom exeptions, to manage and responde with application specific errors.

# Run locally

Clone this repo and move to the folder:

```bash
git clone https://github.com/RobertSDM/be-tiny-drive.git
cd be-tiny-drive
```

If you need run create a virtual environment:

```bash
python -m venv venv
```

Install the project dependencies in the requirements file

```bash
pip install -r requirements.txt
```

The backend part (this) provides a simple mock databade in a container, if you want to use it, run:

```bash
make mock-db
```

The necessary environment variables needed are:

-   `DATABASE_URL`
-   `SUPABASE_URL`
-   `SUPABASE_KEY`
-   `ORIGINS` # Origins to be allowed on CORS
-   `SUPABASE_JWT_SECRET`

Initialize the backend project using the makerfile command:

```bash
make mock-db
```

The necessary environment variables are:

-   `DATABASE_URL`
-   `SUPABASE_URL`
-   `SUPABASE_KEY`
-   `ORIGINS` # Origins to be allowed on CORS
-   `SUPABASE_JWT_SECRET`

Run with:
```bash
# if you already activated the venv
make run
# if you want to run and enter the venv
make env-run
```

## Mocking

-   The authentication in the mock is static. The data is:

```javascript
// jwt_token is to be sent in the authorization header

{
  account: {
    id: "3acd40a6-f384-4e34-8f95-476a0dec91a6",
    creation_date: "2025-05-27T13:51:34.116Z",
    email: "test@gmail.com",
  },
  jwt_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIzYWNkNDBhNi1mMzg0LTRlMzQtOGY5NS00NzZhMGRlYzkxYTYifQ.lvOE26ibRYbZ7NW612e1LHQdgNl14GTy91CE4rcBjTc"
}
```

-   The database is a postgres:16-alpine container
-   The storage is not mocked. The supabase storage service is used.

# API Endpoints

The API was made with Fastapi, so it has a openAPI endpoint documenting the API. If you want to see more details about the API see the endpoint `/docs`"

## Item

-   `GET /item/all/{ownerid}`: Returns a paginated list of all items from the root paginated. Receives a `page`, `order`, and the `sort order`.
-   `GET /item/all/{ownerid}/{parentid}`: Returns a paginated list of all items from a folder. Receives a `page`, `order`, and the `sort order`.
-   `GET /item/search/{ownerid}`: Returns items that the name match the query `query`.
-   `GET /item/{ownerid}/{id}`: Returns one item that match the sent id.
-   `GET /item/download/many/{ownerid}`: Create a zip from the requested items and returns it in a stream.
-   `GET /item/download/folder/{ownerid}/{parentid}`: Create a zip from the items of a folder and returns it in a stream.
-   `GET /item/download/{ownerid}/{id}`: Returns the file bytes in a stream.
-   `GET /item/preview/{ownerid}/{id}`: Returns the preview of a item.
-   `GET /item/breadcrumb/{ownerid}/{id}`: Returns a list representing the path of a folder to the root.
-   `POST /item/save`: Saves the file in the storage and the database.
-   `POST /item/save`: Saves a folder with the sent name.
-   `PUT /item/update/{ownerid}/{id}/name`: Update the name of a item.
-   `DELETE /item/delete/{ownerid}`: Marks a item to be deleted, if the item is a folder marks all its children to be deleted.

# Technologies

## Frameworks

-   Fastapi

## Libraries

-   Alembic
-   Pillow
-   Pytest
-   Python-jose
-   SQLAlchemy
-   Supabase
-   Uvicorn
-   Zstandard

## Cloud

-   Supabase Storage
-   Supabase Authentication
-   Supabase Database - Postgres
-   Render (Server host)
